<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œä¸šæäº¤ç³»ç»Ÿ</title>
    <!-- ä¼˜å…ˆå°è¯•åŠ è½½æœ¬åœ° Tailwindï¼Œå¦‚æœå¤±è´¥è¯·ä½¿ç”¨ CDN -->
    <script src="/static/tailwindcss.js"></script>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg hidden" id="navbar">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">ğŸ“š ä½œä¸šç®¡ç†ç³»ç»Ÿ</h1>
            <div>
                <span id="nav-user" class="mr-4"></span>
                <button onclick="logout()"
                    class="bg-blue-700 px-3 py-1 rounded hover:bg-blue-800 transition">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto p-4">

        <!-- ç™»å½•é¡µ -->
        <div id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-20 fade-in">
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">ç”¨æˆ·ç™»å½•</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ç”¨æˆ·å</label>
                    <input type="text" id="username"
                        class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="student1 æˆ– teacher1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">å¯†ç </label>
                    <input type="password" id="password" class="mt-1 block w-full border border-gray-300 rounded-md p-2"
                        value="123456">
                </div>
                <button onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">ç™» å½•</button>
            </div>
            <p class="mt-4 text-xs text-gray-500 text-center">æµ‹è¯•è´¦å·: teacher1 / 123456 æˆ– student1 / 123456</p>
        </div>

        <!-- è€å¸ˆé¢æ¿ -->
        <div id="teacher-view" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">æˆ‘å‘å¸ƒçš„ä½œä¸š</h2>
                <button onclick="toggleModal('create-modal')"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">+ å‘å¸ƒæ–°ä½œä¸š</button>
            </div>
            <div id="teacher-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
        </div>

        <!-- å­¦ç”Ÿé¢æ¿ -->
        <div id="student-view" class="hidden fade-in">
            <h2 class="text-2xl font-bold mb-6">æˆ‘çš„ä½œä¸šåˆ—è¡¨</h2>
            <div id="student-list" class="space-y-4"></div>
        </div>

    </div>

    <!-- æ¨¡æ€æ¡†ï¼šå‘å¸ƒä½œä¸š -->
    <div id="create-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">å‘å¸ƒæ–°ä½œä¸š</h3>
            <input id="new-title" class="w-full border p-2 mb-2 rounded" placeholder="æ ‡é¢˜">
            <textarea id="new-desc" class="w-full border p-2 mb-2 rounded" placeholder="æè¿°"></textarea>
            <input id="new-date" type="date" class="w-full border p-2 mb-4 rounded">
            <div class="flex justify-end space-x-2">
                <button onclick="toggleModal('create-modal')" class="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                <button onclick="createAssignment()" class="px-4 py-2 bg-blue-600 text-white rounded">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šæŸ¥çœ‹/è¯„åˆ† -->
    <div id="grade-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-full max-w-3xl h-3/4 flex flex-col">
            <div class="flex justify-between mb-4">
                <h3 class="text-lg font-bold">æäº¤è¯¦æƒ…</h3>
                <button onclick="toggleModal('grade-modal')" class="text-red-500">å…³é—­</button>
            </div>
            <div id="subs-list" class="flex-1 overflow-auto space-y-2"></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        let currentRole = '';

        async function api(url, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const res = await fetch(url, options);
            if (res.status === 401) window.location.reload();
            return res.json();
        }

        async function init() {
            const auth = await api('/api/check_auth');
            if (auth.is_logged_in) {
                currentRole = auth.role;
                showDashboard(auth.username, auth.role);
            } else {
                document.getElementById('login-view').classList.remove('hidden');
            }
        }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const res = await api('/api/login', 'POST', { username: u, password: p });
            if (res.status === 'success') {
                currentRole = res.role;
                document.getElementById('login-view').classList.add('hidden');
                showDashboard(res.username, res.role);
            } else {
                alert(res.message);
            }
        }

        async function logout() {
            await api('/api/logout', 'POST');
            window.location.reload();
        }

        function showDashboard(username, role) {
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('nav-user').textContent = `${username} (${role === 'student' ? 'å­¦ç”Ÿ' : 'æ•™å¸ˆ'})`;

            if (role === 'teacher') {
                document.getElementById('teacher-view').classList.remove('hidden');
                loadTeacherData();
            } else {
                document.getElementById('student-view').classList.remove('hidden');
                loadStudentData();
            }
        }

        // --- è€å¸ˆåŠŸèƒ½ ---
        async function loadTeacherData() {
            const list = await api('/api/assignments');
            const container = document.getElementById('teacher-list');
            container.innerHTML = list.map(a => `
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                    <h3 class="font-bold text-lg">${a.title}</h3>
                    <p class="text-gray-600 text-sm mb-2">æˆªæ­¢: ${a.due_date || 'æ— '}</p>
                    <p class="text-gray-500 text-sm truncate">${a.description}</p>
                    <button onclick="viewSubmissions(${a.id})" class="mt-3 text-blue-600 hover:underline text-sm">æŸ¥çœ‹æäº¤ &rarr;</button>
                </div>
            `).join('');
        }

        async function createAssignment() {
            const title = document.getElementById('new-title').value;
            const desc = document.getElementById('new-desc').value;
            const date = document.getElementById('new-date').value;
            if (!title) return alert('æ ‡é¢˜å¿…å¡«');
            await api('/api/assignments', 'POST', { title, desc, date });
            toggleModal('create-modal');
            loadTeacherData();
        }

        async function viewSubmissions(aid) {
            const subs = await api(`/api/teacher/subs/${aid}`);
            const container = document.getElementById('subs-list');
            toggleModal('grade-modal');
            if (subs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— å­¦ç”Ÿæäº¤</p>';
                return;
            }
            container.innerHTML = subs.map(s => `
                <div class="border p-3 rounded bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold">${s.username}</span>
                        <span class="text-xs text-gray-500">${s.submitted_at}</span>
                    </div>
                    <div class="bg-white p-2 border rounded text-sm mb-2 whitespace-pre-wrap">${s.content}</div>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="score-${s.id}" value="${s.score || ''}" class="border w-20 p-1 rounded" placeholder="åˆ†æ•°">
                        <button onclick="grade(${s.id}, ${s.assignment_id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">æ‰“åˆ†</button>
                    </div>
                </div>
            `).join('');
        }

        async function grade(sid, aid) {
            const score = document.getElementById(`score-${sid}`).value;
            if (score < 0 || score > 100) return alert('åˆ†æ•°æ— æ•ˆ');
            await api('/api/grade', 'POST', { sid, aid, score });
            alert('è¯„åˆ†æˆåŠŸ');
        }

        // --- å­¦ç”ŸåŠŸèƒ½ ---
        async function loadStudentData() {
            const list = await api('/api/assignments');
            const container = document.getElementById('student-list');
            container.innerHTML = list.map(a => `
                <div class="bg-white p-6 rounded shadow flex flex-col md:flex-row justify-between">
                    <div class="mb-4 md:mb-0">
                        <div class="flex items-center space-x-2">
                            <h3 class="font-bold text-lg">${a.title}</h3>
                            ${a.score !== null ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">å¾—åˆ†: ${a.score}</span>` : ''}
                        </div>
                        <p class="text-sm text-gray-500">è€å¸ˆ: ${a.teacher_name} | æˆªæ­¢: ${a.due_date || 'æ— '}</p>
                        <p class="mt-2 text-gray-700">${a.description}</p>
                    </div>
                    <div class="w-full md:w-1/3">
                        <textarea id="content-${a.id}" class="w-full border p-2 rounded h-24 text-sm" placeholder="åœ¨æ­¤è¾“å…¥ä½œä¸šå†…å®¹...">${a.my_submission || ''}</textarea>
                        <button onclick="submitHomework(${a.id})" class="mt-2 w-full bg-blue-600 text-white py-1 rounded hover:bg-blue-700 transition">
                            ${a.my_submission ? 'æ›´æ–°æäº¤' : 'æäº¤ä½œä¸š'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function submitHomework(aid) {
            const content = document.getElementById(`content-${aid}`).value;
            if (!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
            await api('/api/submissions', 'POST', { aid, content });
            alert('æäº¤æˆåŠŸï¼');
            loadStudentData();
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        init();
    </script>
</body>

</html>